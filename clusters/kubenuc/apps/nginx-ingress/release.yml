---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: nginx-ingress
  namespace: nginx-ingress
spec:
  interval: 5m
  chart:
    spec:
      chart: ingress-nginx
      version: 4.0.5
      sourceRef:
        kind: HelmRepository
        name: ingress-nginx
        namespace: flux-system
      interval: 5m
  install:
    createNamespace: true
    remediation:
      retries: 6
  upgrade:
    remediation:
      retries: 6
  values:
    controller: 
      # Crowdsec Bouncer
      extraVolumes:
      - name: crowdsec-bouncer-plugin
        emptyDir: {}  
      extraInitContainers:
        - name: init-clone-crowdsec-bouncer
          image: crowdsecurity/lua-bouncer-plugin
          imagePullPolicy: IfNotPresent
          env:
            - name: API_URL
              value: "http://crowdsec-service.crowdsec.svc.cluster.local:8080" # crowdsec lapi service-name
            - name: API_KEY
              value: "8cf4694f8939aff96fccdcedfdd87273" # generated with `cscli bouncers add -n <bouncer_name>
            - name: BOUNCER_CONFIG
              value: "/crowdsec/crowdsec-bouncer.conf"
            - name: SECRET_KEY
              value: "6Le-YQsUAAAAAGD1elr3TDL2Usq_-oWj9iNsiYba" # If you want captcha support otherwise remove this ENV VAR
            - name: SITE_KEY
              value: "6Le-YQsUAAAAAJGgfaaolKrfdaQU3vWlgsrpZNbA" # If you want captcha support otherwise remove this ENV VAR
            - name: BAN_TEMPLATE_PATH
              value: /etc/nginx/lua/plugins/crowdsec/templates/ban.html
            - name: CAPTCHA_TEMPLATE_PATH
              value: /etc/nginx/lua/plugins/crowdsec/templates/captcha.html
          command: ['sh', '-c', "sh /docker_start.sh; mkdir -p /lua_plugins/crowdsec/; cp -R /crowdsec/* /lua_plugins/crowdsec/"]
          volumeMounts:
          - name: crowdsec-bouncer-plugin
            mountPath: /lua_plugins
      extraVolumeMounts:
        - name: crowdsec-bouncer-plugin
          mountPath: /etc/nginx/lua/plugins/crowdsec
          subPath: crowdsec
      setAsDefaultIngress: true
      config:
        plugins: "crowdsec"
        lua-shared-dicts: "crowdsec_cache: 50m"
        server-snippet : |
          lua_ssl_trusted_certificate "/etc/ssl/certs/ca-certificates.crt"; # If you want captcha support otherwise remove this line
          resolver local=on ipv6=off; # If you want captcha support otherwise remove this line
        entries:
          client-max-body-size: "0"
      kind: "deployment"
      nginxplus: false
      appprotect: 
        enable: false
      ingressClass: "nginx"
      useIngressClassOnly: false
      enableCustomResources: true
      globalConfiguration: 
        create: true
      watchNamespace: ""
      service: 
        create: true
        type: "LoadBalancer"
        httpPort: 
          enable: true
          port: "80"
        httpsPort: 
          enable: true
          port: "443"
    imageDefault: true
    prometheus: 
      create: true
      port: "10254"