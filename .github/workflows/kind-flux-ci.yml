name: Kind FluxCD GitOps CI

on:
  pull_request:
    branches: [main]
    paths:
      - 'clusters/kubenuc/**'

env:
  KIND_VERSION: v0.23.0
  KUBECTL_VERSION: v1.30.0

jobs:
  cluster-test:
    runs-on: self-hosted
    timeout-minutes: 120
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Robot Framework and dependencies
        run: |
          pip install --upgrade pip
          pip install robotframework==7.0
          pip install robotframework-seleniumlibrary==6.2.0
          pip install robotframework-requests==0.9.7
          pip install webdriver-manager==4.0.1
          pip install robotframework-jsonlibrary==0.5
          pip install robotframework-datadriver==1.11.1
          
          # Verify installation
          robot --version || true
          python -c "import SeleniumLibrary; print(f'SeleniumLibrary: {SeleniumLibrary.__version__}')" || true

      - name: Install Chrome for Selenium
        run: |
          #wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          #sudo echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list
          #sudo apt-get update
          #sudo apt-get install -y google-chrome-stable
          
          # Verify Chrome installation
          google-chrome --version

      - name: Setup Flux
        uses: fluxcd/flux2/action@main

      - name: Create Kind config
        run: |
          cat > /tmp/kind-config.yaml <<'EOF'
          kind: Cluster
          apiVersion: kind.x-k8s.io/v1alpha4
          containerdConfigPatches:
          - |-
            [plugins."io.containerd.grpc.v1.cri".registry]
              [plugins."io.containerd.grpc.v1.cri".registry.mirrors]
                [plugins."io.containerd.grpc.v1.cri".registry.mirrors."docker.io"]
                  endpoint = ["https://harbor.ddlns.net/v2/dolibarr/"]
          nodes:
          - role: control-plane
          EOF

      - name: Setup Kubernetes
        uses: helm/kind-action@v1.13.0
        with:
          cluster_name: kubenuc-test
          version: v0.30.0
          node_image: kindest/node:v1.33.4
          cloud_provider: true
          config: /tmp/kind-config.yaml

      - name: Install Flux in Kubernetes Kind
        run: |
          flux install --timeout=5m
          
      - name: Verify Flux installation
        run: |
          kubectl -n flux-system wait --for=condition=ready pod --all --timeout=5m
          
          # Verify all Flux components are installed
          echo "Checking Flux components..."
          kubectl -n flux-system get deploy
          
          # Check CRDs are installed
          echo "Checking Flux CRDs..."
          kubectl get crds | grep -E "(fluxcd|toolkit)" || echo "No Flux CRDs found"
          
          # Verify HelmRelease CRD exists
          kubectl get crd helmreleases.helm.toolkit.fluxcd.io || echo "⚠️ HelmRelease CRD not found"

      # Install cert-manager for SSL certificates
      - name: Install cert-manager
        run: |
          kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.14.0/cert-manager.yaml
          kubectl -n cert-manager wait --for=condition=ready pod --all --timeout=5m

      # Create self-signed ClusterIssuer for testing
      - name: Create test ClusterIssuer
        run: |
          kubectl apply -f - <<EOF
          apiVersion: cert-manager.io/v1
          kind: ClusterIssuer
          metadata:
            name: letsencrypt
          spec:
            selfSigned: {}
          EOF

      - name: Deploy 1password
        run: |
          kubectl create ns 1password || true
          kubectl create secret generic onepassword-secret --from-literal=token=${{ secrets.OP_TOKEN }} --namespace=1password || true

      - name: Bootstrap Flux with main branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CURRENT_BRANCH="${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}"

          echo "=== Bootstrapping Flux with main branch (stable config) ==="
          flux bootstrap github \
            --owner=dark-vex \
            --repository=infra-cd \
            --branch=main \
            --path=./clusters/kubenuc-test \
            --personal=false \
            --timeout=60m \
            --token-auth

          echo "=== Waiting for Flux components to be ready ==="
          kubectl wait --for=condition=ready pod \
            -l app=source-controller \
            -n flux-system \
            --timeout=5m

          kubectl wait --for=condition=ready pod \
            -l app=kustomize-controller \
            -n flux-system \
            --timeout=5m

          kubectl wait --for=condition=ready pod \
            -l app=helm-controller \
            -n flux-system \
            --timeout=5m

          kubectl wait --for=condition=ready pod \
            -l app=notification-controller \
            -n flux-system \
            --timeout=5m

          echo "=== Flux bootstrapped with main branch ==="

      - name: Patch GitRepository to use current branch
        run: |
          CURRENT_BRANCH="${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}"

          echo "=== Patching GitRepository to use branch: ${CURRENT_BRANCH} ==="
          kubectl patch gitrepository flux-system -n flux-system \
            --type merge \
            --patch "{\"spec\":{\"ref\":{\"branch\":\"${CURRENT_BRANCH}\"}}}"

          echo "=== Waiting for GitRepository to reconcile ==="
          sleep 5
          kubectl wait --for=condition=ready \
            gitrepository/flux-system \
            -n flux-system \
            --timeout=30m

          echo "Waiting for charts to be ready..."
          kubectl -n flux-system wait kustomization/charts --for=condition=ready --timeout=10m || true
          
          echo "Waiting for apps to reconcile..."
          kubectl -n flux-system wait kustomization/apps --for=condition=ready --timeout=30m || true

      - name: Monitor Flux resources
        run: |
          echo "=== GitRepositories ==="
          flux get sources git -A

          echo "=== HelmRepositories ==="
          flux get sources helm -A

          echo "=== Kustomizations ==="
          flux get kustomizations -A

          echo "=== HelmReleases ==="
          flux get helmreleases -A

      - name: Smoke test - Check all pods
        run: |
          echo "=== All Pods Status ==="
          kubectl get pods -A

          echo "=== All Namespaces ==="
          kubectl get namespaces

      - name: Show Flux events on failure
        if: failure()
        run: |
          echo "=== Flux Events ==="
          kubectl get events -n flux-system --sort-by='.lastTimestamp'

          echo "=== Failed Kustomizations ==="
          flux get kustomizations -A | grep -i false || true

          echo "=== Failed HelmReleases ==="
          flux get helmreleases -A | grep -i false || true

          echo "=== Logs from source-controller ==="
          kubectl logs -n flux-system -l app=source-controller --tail=100 || true

          echo "=== Logs from kustomize-controller ==="
          kubectl logs -n flux-system -l app=kustomize-controller --tail=100 || true

          echo "=== Logs from helm-controller ==="
          kubectl logs -n flux-system -l app=helm-controller --tail=100 || true

      - name: Cleanup - Delete kind cluster
        if: always()
        run: |
          kind delete cluster --name kubenuc-test
