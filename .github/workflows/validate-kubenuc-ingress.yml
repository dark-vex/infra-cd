name: kubenuc-ingress-e2e

on:
  pull_request:
    branches: [main]
    paths:
      - 'clusters/kubenuc/apps/emissary-ingress/**'
      - 'clusters/kubenuc/apps/jellyfin/**'
      - 'clusters/kubenuc/apps/jenkins/**'
      - 'clusters/kubenuc/apps/nextcloud/**'
      - 'clusters/kubenuc/apps/s3/**'
      - 'clusters/kubenuc/apps/nginx-ingress/**'
      - 'clusters/kubenuc/charts/**'
      - '.github/workflows/validate-kubenuc-ingress.yml'

jobs:
  validate-ingress:
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Flux
        uses: fluxcd/flux2/action@main

      - name: Setup Kubernetes
        uses: helm/kind-action@v1.12.0
        with:
          cluster_name: kubenuc-test
          version: v0.30.0
          node_image: kindest/node:v1.33.4

      - name: Install Flux in Kubernetes Kind
        run: flux install --components-extra source-watcher

      - name: Verify Flux installation
        run: kubectl -n flux-system wait --for=condition=ready pod --all --timeout=5m

      # Deploy PostgreSQL for testing (simple deployment for Kind)
      - name: Deploy PostgreSQL for testing
        run: |
          kubectl create namespace databases || true
          kubectl apply -f - <<EOF
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: postgresql-test
            namespace: databases
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: postgresql
            template:
              metadata:
                labels:
                  app: postgresql
              spec:
                containers:
                - name: postgres
                  image: postgres:15
                  env:
                  - name: POSTGRES_PASSWORD
                    value: testpassword
                  - name: POSTGRES_USER
                    value: postgres
                  ports:
                  - containerPort: 5432
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: postgresql-nuc-cluster
            namespace: databases
          spec:
            selector:
              app: postgresql
            ports:
            - port: 5432
              targetPort: 5432
          EOF

      - name: Wait for PostgreSQL to be ready
        run: |
          kubectl -n databases wait --for=condition=ready pod -l app=postgresql --timeout=3m

      # Create mock secrets for testing (replaces OnePassword secrets)
      - name: Create mock secrets
        run: |
          # Create namespaces
          kubectl create namespace nextcloud-fastnetserv || true
          kubectl create namespace sso || true
          kubectl create namespace harbor || true
          
          # Nextcloud secrets
          kubectl apply -f - <<EOF
          apiVersion: v1
          kind: Secret
          metadata:
            name: nextcloud
            namespace: nextcloud-fastnetserv
          type: Opaque
          stringData:
            nextcloud-username: admin
            nextcloud-password: testpassword123
          ---
          apiVersion: v1
          kind: Secret
          metadata:
            name: nextcloud-db-secret
            namespace: nextcloud-fastnetserv
          type: Opaque
          stringData:
            server: postgresql-nuc-cluster.databases.svc.cluster.local
            database: nextcloud
            pgdb-username: nextcloud
            pgdb-password: testpassword
          ---
          apiVersion: v1
          kind: Secret
          metadata:
            name: nextcloud-mariadb
            namespace: nextcloud-fastnetserv
          type: Opaque
          stringData:
            mariadb-password: testpassword
            mariadb-root-password: testpassword
          ---
          apiVersion: v1
          kind: Secret
          metadata:
            name: nextcloud-db-backup
            namespace: nextcloud-fastnetserv
          type: Opaque
          stringData:
            S3_ACCESS_KEY_ID: test
            S3_SECRET_ACCESS_KEY: test
            S3_BUCKET: test
          EOF
          
          # SSO secrets
          kubectl apply -f - <<EOF
          apiVersion: v1
          kind: Secret
          metadata:
            name: sso-secrets
            namespace: sso
          type: Opaque
          stringData:
            PG_HOST: postgresql-nuc-cluster.databases.svc.cluster.local
            PG_PASS: testpassword
            AUTHENTIK_SECRET_KEY: test-secret-key-123456789012345678901234567890
            PGUSERNAME: postgres
            PGPASSWORD: testpassword
          ---
          apiVersion: v1
          kind: Secret
          metadata:
            name: zitadel-db-credentials
            namespace: sso
          type: Opaque
          stringData:
            ZITADEL_DATABASE_POSTGRES_HOST: postgresql-nuc-cluster.databases.svc.cluster.local
            ZITADEL_DATABASE_POSTGRES_PORT: "5432"
            ZITADEL_DATABASE_POSTGRES_DATABASE: zitadel
            ZITADEL_DATABASE_POSTGRES_USER_USERNAME: zitadel
            ZITADEL_DATABASE_POSTGRES_USER_PASSWORD: testpassword
          ---
          apiVersion: v1
          kind: Secret
          metadata:
            name: zitadel-master-secrets
            namespace: sso
          type: Opaque
          stringData:
            masterkey: test-master-key-123456789012345678901234
          EOF
          
          # Harbor secrets
          kubectl apply -f - <<EOF
          apiVersion: v1
          kind: Secret
          metadata:
            name: harbor-secrets
            namespace: harbor
          type: Opaque
          stringData:
            password: testpassword
          ---
          apiVersion: v1
          kind: Secret
          metadata:
            name: redis-password-secret
            namespace: harbor
          type: Opaque
          stringData:
            redis-password: testpassword
          ---
          apiVersion: v1
          kind: Secret
          metadata:
            name: harbor-db-backup
            namespace: harbor
          type: Opaque
          stringData:
            S3_ACCESS_KEY_ID: test
            S3_SECRET_ACCESS_KEY: test
            S3_BUCKET: test
          EOF

      # Deploy main branch with PostgreSQL operator excluded
      - name: Main branch setup
        run: |
          kubectl cluster-info --context kind-kubenuc-test

          flux create source git flux-system \
          --url=${{ github.event.repository.html_url }} \
          --branch=main \
          --interval=15m \
          --username=${GITHUB_ACTOR} \
          --password=${{ secrets.GITHUB_TOKEN }} \
          --ignore-paths="clusters/**/flux-system/,clusters/kubenuc/apps/postgresql/**" \
          --timeout=60m

          flux create kustomization flux-system \
          --source=flux-system \
          --interval=15m \
          --path=./clusters/kubenuc \
          --timeout=60m

      - name: Verify cluster reconciliation (main branch)
        run: |
          kubectl -n flux-system wait kustomization/apps --for=condition=ready --timeout=30m || true

      # Test feature branch changes
      - name: Apply feature branch changes
        run: |
          kubectl cluster-info --context kind-kubenuc-test

          flux create source git flux-system \
          --url=${{ github.event.repository.html_url }} \
          --branch=${GITHUB_REF#refs/heads/} \
          --username=${GITHUB_ACTOR} \
          --password=${{ secrets.GITHUB_TOKEN }} \
          --ignore-paths="clusters/**/flux-system/,clusters/kubenuc/apps/postgresql/**" \
          --export | kubectl apply -f -

          flux create kustomization flux-system \
          --source=flux-system \
          --path=./clusters/kubenuc \
          --export | kubectl apply -f -

      - name: Verify cluster reconciliation (feature branch)
        run: |
          kubectl -n flux-system wait kustomization/flux-system --for=condition=ready --timeout=10m || true
          kubectl -n flux-system wait kustomization/apps --for=condition=ready --timeout=10m || true

      - name: List deployed resources
        run: flux tree ks flux-system

      - name: Check ingress resources
        run: |
          echo "=== Ingress Controller Pods ==="
          kubectl -n ingress-nginx get pods
          
          echo "=== Ingress Resources ==="
          kubectl get ingress -A
          
          echo "=== Services ==="
          kubectl get svc -A | grep -E '(ingress|LoadBalancer)'

      - name: Debug failure
        if: failure()
        run: |
          echo "=== Flux System Resources ==="
          kubectl -n flux-system get all
          
          echo "=== Source Controller Logs ==="
          kubectl -n flux-system logs deploy/source-controller --tail=100
          
          echo "=== Kustomize Controller Logs ==="
          kubectl -n flux-system logs deploy/kustomize-controller --tail=100
          
          echo "=== Helm Controller Logs ==="
          kubectl -n flux-system logs deploy/helm-controller --tail=100
          
          echo "=== All Flux Resources ==="
          flux get all --all-namespaces
          
          echo "=== Kustomization Status ==="
          kubectl -n flux-system get kustomizations -o yaml
          
          echo "=== HelmRelease Status ==="
          kubectl get helmreleases -A -o yaml
